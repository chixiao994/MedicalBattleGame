name: Fix Android Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Create missing Gradle files
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p gradle/wrapper
        mkdir -p app/src/main/java/com/medical/battle
        mkdir -p app/src/main/res/layout
        
        # 1. åˆ›å»ºgradle-wrapper.propertiesï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f gradle/wrapper/gradle-wrapper.properties ]; then
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
          echo "âœ… Created gradle-wrapper.properties"
        fi
        
        # 2. åˆ›å»ºsettings.gradle.ktsï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f settings.gradle.kts ]; then
          cat > settings.gradle.kts << 'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "MedicalBattleGame"
include(":app")
EOF
          echo "âœ… Created settings.gradle.kts"
        fi
        
        # 3. åˆ›å»ºæ ¹ç›®å½•build.gradle.ktsï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f build.gradle.kts ]; then
          cat > build.gradle.kts << 'EOF'
plugins {
    id("com.android.application") version "8.1.2" apply false
    id("org.jetbrains.kotlin.android") version "1.9.0" apply false
}
EOF
          echo "âœ… Created build.gradle.kts"
        fi
        
        # 4. åˆ›å»ºgradle.propertiesï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f gradle.properties ]; then
          cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
kotlin.code.style=official
EOF
          echo "âœ… Created gradle.properties"
        fi
        
        # 5. åˆ›å»ºapp/build.gradle.ktsï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f app/build.gradle.kts ]; then
          cat > app/build.gradle.kts << 'EOF'
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.medical.battle"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.medical.battle"
        minSdk = 21
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
        }
    }
    
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }
    
    kotlinOptions {
        jvmTarget = "1.8"
    }
}

dependencies {
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.10.0")
}
EOF
          echo "âœ… Created app/build.gradle.kts"
        fi
        
        # 6. åˆ›å»ºAndroidManifest.xmlï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f app/src/main/AndroidManifest.xml ]; then
          cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:allowBackup="true"
        android:label="åŒ»æˆ˜æ¸¸æˆ"
        android:theme="@style/Theme.MedicalBattleGame">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:screenOrientation="portrait">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
          echo "âœ… Created AndroidManifest.xml"
        fi
        
        # 7. åˆ›å»ºMainActivity.ktï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f app/src/main/java/com/medical/battle/MainActivity.kt ]; then
          mkdir -p app/src/main/java/com/medical/battle
          cat > app/src/main/java/com/medical/battle/MainActivity.kt << 'EOF'
package com.medical.battle

import android.os.Bundle
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        val tvTitle = findViewById<TextView>(R.id.tv_title)
        val btnStart = findViewById<Button>(R.id.btn_start)
        
        tvTitle.text = "ğŸ¥ åŒ»æˆ˜æ¸¸æˆ"
        
        btnStart.setOnClickListener {
            tvTitle.text = "æ¸¸æˆå¼€å§‹ï¼\né€‰æ‹©ç—‡çŠ¶è¿›è¡Œè¾¨è¯"
        }
    }
}
EOF
          echo "âœ… Created MainActivity.kt"
        fi
        
        # 8. åˆ›å»ºå¸ƒå±€æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f app/src/main/res/layout/activity_main.xml ]; then
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="20dp"
    android:background="#f0f0f0"
    android:gravity="center">
    
    <TextView
        android:id="@+id/tv_title"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ä¸­åŒ»å¯¹æˆ˜æ¸¸æˆ"
        android:textSize="28sp"
        android:textStyle="bold"
        android:gravity="center"
        android:textColor="#2E7D32"
        android:layout_marginBottom="40dp"/>
    
    <Button
        android:id="@+id/btn_start"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="å¼€å§‹æ¸¸æˆ"
        android:backgroundTint="#4CAF50"
        android:textColor="#FFFFFF"
        android:padding="20dp"
        android:textSize="18sp"/>
        
</LinearLayout>
EOF
          echo "âœ… Created activity_main.xml"
        fi
        
    - name: Download gradlew if missing
      run: |
        if [ ! -f gradlew ]; then
          wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x gradlew
          echo "âœ… Downloaded gradlew"
        fi
        
    - name: Create local.properties
      run: echo "sdk.dir=$ANDROID_HOME" > local.properties
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon
      
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: medical-battle-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: Show success message
      run: |
        echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
        echo "ğŸ“± APKå·²ç”Ÿæˆï¼Œå¯åœ¨Artifactsä¸­ä¸‹è½½"
        echo "ğŸ“¥ ä¸‹è½½åå®‰è£…åˆ°æ‰‹æœºå³å¯è¿è¡Œ"
